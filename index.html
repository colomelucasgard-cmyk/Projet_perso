<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pour Toi</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        /* --- RESET & BASE --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background: linear-gradient(to bottom, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            font-family: 'Zen Maru Gothic', sans-serif;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* --- ARRI√àRE-PLAN --- */
        #bg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0; transition: opacity 2s ease-in-out; }
        .bg-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 2s ease-in-out; }
        .bg-slide.active { opacity: 1; }
        #overlay-filter { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(40, 10, 20, 0.5); z-index: 1; opacity: 0; transition: opacity 2s; }

        /* --- CANVAS --- */
        #canvas-sakura { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #canvas-fog { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; cursor: crosshair; transition: opacity 1.5s ease-out; }

        /* --- HISTOIRE --- */
        #story-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; color: white; width: 90%; pointer-events: none; transition: opacity 0.5s ease-in-out; opacity: 0; }
        .big-icon { font-size: 5rem; margin-bottom: 20px; display: block; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); animation: float 3s infinite ease-in-out; }
        .story-text { font-family: 'Great Vibes', cursive; font-size: 2.2rem; text-shadow: 0 2px 10px rgba(0,0,0,0.2); color: #d6336c; transition: color 2s; }
        @keyframes float { 0%, 100% {transform: translateY(0) scale(1);} 50% {transform: translateY(-15px) scale(1.1);} }

        /* --- FINAL CONTENT --- */
        #final-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; opacity: 0; transition: opacity 2.5s ease-out; pointer-events: none; display: none; }
        h1 { font-family: 'Great Vibes', cursive; font-size: 3.5rem; color: #fff0f5; margin: 0 0 10px 0; text-shadow: 0 4px 6px rgba(0,0,0,0.5); line-height: 1.2; }
        p.subtitle { font-size: 1.1rem; color: #ffd1dc; margin-bottom: 40px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.5); padding: 0 20px; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px; padding: 15px 25px; margin: 10px; width: 70%; max-width: 300px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); }
        .interactive-panel { cursor: pointer; transition: transform 0.2s; pointer-events: auto !important; }
        .interactive-panel:active { transform: scale(0.95); }
        .timer-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: #ffb7c5; }
        .timer-val { font-size: 1.3rem; font-weight: bold; color: white; margin-top: 5px; }

        /* --- COM√àTES (Your Name) --- */
        #comet-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; overflow: hidden; }
        .comet { position: absolute; border-radius: 50%; filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.9)); opacity: 0; }
        .comet-head { width: 4px; height: 4px; background: #fff; border-radius: 50%; position: relative; z-index: 2; }
        .comet-tail { position: absolute; top: 50%; right: 0; width: 200px; height: 2px; transform: translateY(-50%); border-radius: 100%; z-index: 1; transform-origin: right center; }
        @keyframes shooting-star { 0% { transform: translateX(0) translateY(0) rotate(-45deg) scale(0.8); opacity: 0; } 10% { opacity: 1; } 80% { opacity: 1; } 100% { transform: translateX(-150vw) translateY(150vh) rotate(-45deg) scale(1.2); opacity: 0; } }
        .comet.blue .comet-tail { background: linear-gradient(to left, rgba(0,0,0,0), rgba(100, 220, 255, 0.8), #fff); }
        .comet.pink .comet-tail { background: linear-gradient(to left, rgba(0,0,0,0), rgba(255, 100, 150, 0.8), #fff); }

        /* --- VINYLE & MUSIQUE --- */
        #music-player-container { position: absolute; bottom: 25px; right: 25px; z-index: 100; display: flex; flex-direction: column; align-items: center; opacity: 0; transition: opacity 2s; }
        .vinyl-wrapper { width: 90px; height: 90px; position: relative; cursor: pointer; }
        .vinyl-disc { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, #1a1a1a 20%, #333 21%, #1a1a1a 22%, #1a1a1a 30%, #333 31%, #1a1a1a 32%, #1a1a1a 40%, #222 100%); border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 8px 25px rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; animation: spin 5s linear infinite; animation-play-state: paused; }
        .vinyl-label { width: 35%; height: 35%; background: #e9967a; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: inset 0 0 8px rgba(0,0,0,0.3); }
        .vinyl-heart { font-size: 1.4rem; filter: drop-shadow(0 0 5px white); transition: transform 0.1s ease-out; }
        .tonearm { position: absolute; top: -15px; right: -10px; width: 35px; height: 50px; border-top: 4px solid #d4af37; border-right: 4px solid #d4af37; border-radius: 0 12px 0 0; transform-origin: top right; transform: rotate(0deg); transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; }
        .playing .tonearm { transform: rotate(28deg); }
        .playing .vinyl-disc { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- COFFRE FORT (STYLE LETTRE) --- */
        #safe-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 15, 15, 0.92); backdrop-filter: blur(12px); z-index: 200; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.6s ease; }
        #safe-modal.open { opacity: 1; pointer-events: auto; }
        #safe-interface { background: #fdf5e6; padding: 40px 30px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 100px rgba(212, 175, 55, 0.1); text-align: center; border: 1px solid #d4af37; max-width: 320px; }
        .safe-title { font-family: 'Great Vibes', cursive; font-size: 2rem; color: #8b4513; margin-bottom: 20px; }
        .safe-display { font-family: 'Zen Maru Gothic', sans-serif; background: none; color: #d6336c; font-size: 2.5rem; letter-spacing: 8px; margin-bottom: 30px; border-bottom: 2px dashed #d4af37; padding-bottom: 5px; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .key-btn { width: 65px; height: 65px; border-radius: 50%; background: #fff; border: 1px solid #eee; color: #8b4513; font-size: 1.4rem; font-weight: bold; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 0 #e6e6e6; transition: all 0.1s; }
        .key-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #e6e6e6; background: #fffaf0; }

        /* --- TICKET --- */
        #reward-ticket { display: none; background: #fff; padding: 40px 20px; border: 8px double #d4af37; text-align: center; border-radius: 5px; position: relative; animation: unfold 0.8s ease-out; }
        @keyframes unfold { from { transform: scaleY(0); opacity: 0; } to { transform: scaleY(1); opacity: 1; } }
        .ticket-header { font-family: 'Great Vibes', cursive; font-size: 2.8rem; color: #d4af37; margin: 0; }
        .stamp-wax { width: 60px; height: 60px; background: #b22222; border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; color: gold; font-size: 1.5rem; box-shadow: 2px 2px 10px rgba(0,0,0,0.3); transform: rotate(-10deg); }

        .vault-btn { background: rgba(212, 175, 55, 0.2) !important; border: 1px solid #d4af37 !important; animation: pulse-gold 2s infinite; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }

        /* --- CARTE INTERACTIVE --- */
        #map-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 10, 10, 0.95); z-index: 250; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        #map-modal.open { opacity: 1; pointer-events: auto; }
        #map-container { width: 90%; height: 70%; border: 4px solid #d4af37; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.8); position: relative; overflow: hidden; background: #fdf5e6; }
        .vintage-map-layer { filter: sepia(0.6) contrast(1.1) brightness(0.9) hue-rotate(-10deg); }
        .leaflet-popup-content-wrapper { background: rgba(255, 250, 240, 0.95); border: 1px solid #d4af37; border-radius: 5px; font-family: 'Zen Maru Gothic', sans-serif; text-align: center; }
        .leaflet-popup-tip { background: #d4af37; }
        .map-title { color: #d4af37; font-family: 'Great Vibes', cursive; font-size: 2.5rem; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .custom-pin {
        background: transparent !important;
        border: none !important;
        font-size: 2.5rem; /* Un peu plus gros pour bien voir */
        line-height: 1;
        display: flex !important;
        justify-content: center;
        align-items: center;
        text-shadow: 0 4px 8px rgba(0,0,0,0.4);
        animation: floatPin 2s infinite ease-in-out;
        }
        @keyframes floatPin { 
        0%, 100% { transform: translateY(0); } 
        50% { transform: translateY(-8px); } 
        }
    </style>
</head>
<body>

    <div id="bg-container"></div>
    <div id="overlay-filter"></div>
    <div id="comet-container"></div>

    <canvas id="canvas-sakura"></canvas>
    <canvas id="canvas-fog"></canvas>

    <div id="story-container">
        <span id="story-icon" class="big-icon">üëÜ</span>
        <span id="story-text" class="story-text">Touche l'√©cran...</span>
    </div>

    <div id="final-content">
        <h1>Joyeuse<br>Saint-Valentin</h1>
        <p class="subtitle">Pour mon √¢me soeur que j'aime tant</p>

        <div class="glass-panel">
            <div class="timer-label">Premier Bisou</div>
            <div id="timer-kiss" class="timer-val">...</div>
        </div>

        <div class="glass-panel">
            <div class="timer-label">Officiellement Nous</div>
            <div id="timer-official" class="timer-val">...</div>
        </div>

        <div class="glass-panel interactive-panel" style="margin-top: 25px; pointer-events: auto;" onclick="newReason()">
            <div class="timer-label">Pourquoi je t'aime ?</div>
            <div id="love-reason" class="timer-val" style="font-size: 1.1rem; font-weight: normal; min-height: 1.5em;">Clique ici...</div>
        </div>
    </div>

    <audio id="bg-music" src="Gorillaz.mp3" loop crossOrigin="anonymous"></audio>

    <div id="music-player-container">
        <div class="vinyl-wrapper" id="vinyl-btn">
            <div class="tonearm"></div>
            <div class="vinyl-disc">
                <div class="vinyl-label"><div class="vinyl-heart">‚ù§Ô∏è</div></div>
            </div>
        </div>
    </div>

    <div id="map-modal">
        <div class="map-title">Nos Souvenirs & Aventures</div>
        <div id="map-container"></div>
        <button onclick="closeMap()" style="margin-top:20px; padding:10px 25px; background:transparent; border:1px solid #d4af37; color:#d4af37; border-radius:20px; cursor:pointer; font-family:'Zen Maru Gothic';">Retour</button>
    </div>

    <div id="safe-modal">
        <div id="safe-interface">
            <div class="safe-title">Un secret pour toi...</div>
            <div class="safe-display" id="safe-screen">----</div>
            <div class="keypad">
                <div class="key-btn" onclick="inputSafe(1)">1</div>
                <div class="key-btn" onclick="inputSafe(2)">2</div>
                <div class="key-btn" onclick="inputSafe(3)">3</div>
                <div class="key-btn" onclick="inputSafe(4)">4</div>
                <div class="key-btn" onclick="inputSafe(5)">5</div>
                <div class="key-btn" onclick="inputSafe(6)">6</div>
                <div class="key-btn" onclick="inputSafe(7)">7</div>
                <div class="key-btn" onclick="inputSafe(8)">8</div>
                <div class="key-btn" onclick="inputSafe(9)">9</div>
                <div class="key-btn" style="background:#f8d7da" onclick="closeSafe()">‚úï</div>
                <div class="key-btn" onclick="inputSafe(0)">0</div>
                <div class="key-btn" style="background:#fff3cd" onclick="clearSafe()">‚Üê</div>
            </div>
        </div>

        <div id="reward-ticket">
            <h2 class="ticket-header">Invitation</h2>
            <div class="stamp-wax">‚ù§</div>
            <p style="letter-spacing: 1px; color: #555;">Valable pour</p>
            <div style="font-weight: bold; font-size: 1.2rem; color: #8b4513; margin: 15px 0;">LE RESTAURANT DE TON CHOIX</div>
            <p style="font-style: italic; font-size: 0.9rem; color: #999;">"Parce que chaque moment avec toi est un festin."</p>
            <button onclick="closeSafe()" style="margin-top:25px; padding:12px 30px; background:#d4af37; color:white; border:none; border-radius:25px; font-family: 'Zen Maru Gothic'; cursor:pointer;">Garder pr√©cieusement</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG & VARIABLES
        // ==========================================
        const images = [
            'nous1.jpg', '1000014222.jpg', '1000014295.jpg',
            '1000014591.jpg', '1000014933.jpg', '1000015425.jpg',
            '1000016105.jpg', '1000022693.jpg'
        ];
        const dateKiss = new Date(2025, 5, 1, 0, 0, 0); 
        const dateOfficial = new Date(2025, 6, 17, 0, 0, 0); 

        const scenario = [
            { text: "Pour ma meilleure amie et partenaire", icon: "üíê" }, 
            { text: "Pour celle qui me soutient et rend ma vie meilleure", icon: "üåü" }, 
            { text: "Pour celle que je n'abandonnerai jamais", icon: "‚ôæÔ∏è" }, 
            { text: "Laisse moi te montrer √† quel point je t'aime", icon: "üíå" } 
        ];

        const loveReasons = [
            "Parce que tu es ma personne pr√©f√©r√©e", "Pour la fa√ßon dont tu me regardes",
            "Parce qu'avec toi, tout est encore plus magique", "Pour ton rire qui illumine mes journ√©es",
            "Parce que tu me pousses vers le haut", "Pour nos projets futurs",
            "Parce que tu es belle √† l'int√©rieur comme √† l'ext√©rieur", "Pour ta gentillesse infinie",
            "Parce que je me sens prot√©g√© avec toi", "Parce que je serai pour toujours ton roi des cafards",
            "Parce que tu vaux infiniment plus que tout ce que l'on a d√©j√† dit sur toi",
            "Parce que tu prends soin de nous", "Parce que mon amour pour toi est infini"
        ];

        let step = -1; 
        let isAnimating = false;
        let fogCleared = false;
        let windX = 0, windY = 0;

        // ==========================================
        // SYSTEME DE BU√âE
        // ==========================================
        const canvasFog = document.getElementById('canvas-fog');
        const ctxFog = canvasFog.getContext('2d');

        function resizeFog() {
            canvasFog.width = window.innerWidth;
            canvasFog.height = window.innerHeight;
            ctxFog.fillStyle = "rgba(255, 255, 255, 0.85)";
            ctxFog.fillRect(0, 0, canvasFog.width, canvasFog.height);
            ctxFog.globalCompositeOperation = 'source-over';
            ctxFog.font = "30px 'Great Vibes'";
            ctxFog.fillStyle = "#ff758c";
            ctxFog.textAlign = "center";
            ctxFog.fillText("Essuie la bu√©e...", canvasFog.width/2, canvasFog.height/2);
        }
        resizeFog();

        function scratch(x, y) {
            if(fogCleared) return;
            ctxFog.globalCompositeOperation = 'destination-out';
            ctxFog.beginPath();
            ctxFog.arc(x, y, 40, 0, Math.PI * 2);
            ctxFog.fill();
            checkFogCleared();
        }

        let scratchCount = 0;
        function checkFogCleared() {
            scratchCount++;
            if(scratchCount > 60 && !fogCleared) {
                fogCleared = true;
                canvasFog.style.opacity = 0;
                document.getElementById('story-container').style.opacity = 1;
                setTimeout(() => { canvasFog.style.display = 'none'; }, 1500);
            }
        }
        canvasFog.addEventListener('touchmove', (e) => { e.preventDefault(); scratch(e.touches[0].clientX, e.touches[0].clientY); });
        canvasFog.addEventListener('mousemove', (e) => { if(e.buttons === 1) scratch(e.clientX, e.clientY); });

        // ==========================================
        // SYSTEME D'HISTOIRE & CLICK
        // ==========================================
        const storyContainer = document.getElementById('story-container');
        const storyText = document.getElementById('story-text');
        const storyIcon = document.getElementById('story-icon');
        const finalContent = document.getElementById('final-content');
        const overlayFilter = document.getElementById('overlay-filter');
        const bgContainer = document.getElementById('bg-container');

        function handleTap(e) {
            if(!fogCleared) return; 
            if (e.target.closest('.interactive-panel') || e.target.closest('button')) return;
            if(isAnimating) return; 
            isAnimating = true;
            step++; 
            if (navigator.vibrate) navigator.vibrate(50);

            if (step < scenario.length) {
                storyContainer.style.opacity = 0;
                setTimeout(() => {
                    storyText.innerText = scenario[step].text;
                    storyIcon.innerText = scenario[step].icon;
                    storyContainer.style.opacity = 1;
                    isAnimating = false;
                }, 500);
            } else {
                storyContainer.style.opacity = 0;
                setTimeout(() => {
                    storyContainer.style.display = 'none';
                    bgContainer.style.opacity = 1;
                    overlayFilter.style.opacity = 1;
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    finalContent.style.display = 'flex';
                    setTimeout(() => {
                        finalContent.style.opacity = 1;
                        finalContent.style.pointerEvents = 'auto'; 
                    }, 100);
                }, 500);
            }
        }
        window.addEventListener('touchstart', handleTap);
        window.addEventListener('click', handleTap);

        // ==========================================
        // FOND D'√âCRAN & TIMER
        // ==========================================
        if(images.length > 0) {
            images.forEach((img, i) => {
                const el = document.createElement('div');
                el.classList.add('bg-slide');
                el.style.backgroundImage = `url('${img}')`;
                if(i === 0) el.classList.add('active');
                bgContainer.appendChild(el);
            });
        }
        let curSlide = 0;
        setInterval(() => {
            const slides = document.querySelectorAll('.bg-slide');
            if(slides.length > 1) {
                slides[curSlide].classList.remove('active');
                curSlide = (curSlide + 1) % slides.length;
                slides[curSlide].classList.add('active');
            }
        }, 5000);

        function getDuration(startDate) {
            const now = new Date();
            const diff = now - startDate;
            if (diff < 0) return "Bient√¥t..."; 
            const days = Math.floor(diff / (86400000));
            const hours = Math.floor((diff % 86400000) / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            return `${days}j ${hours}h ${mins}m`;
        }
        setInterval(() => {
            document.getElementById('timer-kiss').innerText = getDuration(dateKiss);
            document.getElementById('timer-official').innerText = getDuration(dateOfficial);
        }, 1000);

        function newReason() {
            if(navigator.vibrate) navigator.vibrate(30);
            const reasonDiv = document.getElementById('love-reason');
            reasonDiv.style.opacity = 0;
            setTimeout(() => {
                reasonDiv.innerText = loveReasons[Math.floor(Math.random() * loveReasons.length)];
                reasonDiv.style.opacity = 1;
            }, 300);
        }

        // ==========================================
        // CANVAS SAKURA & ACCELEROMETRE
        // ==========================================
        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', function(event) {
                if (step >= scenario.length) {
                    let acc = event.accelerationIncludingGravity;
                    if (acc) { windX = -acc.x * 0.5; windY = acc.y * 0.5; }
                }
            });
        }

        const canvas = document.getElementById('canvas-sakura');
        const ctx = canvas.getContext('2d');
        let petals = [];
        
        function resizeSakura() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeSakura);
        resizeSakura();

        class Petal {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height; 
                this.size = Math.random() * 10 + 5;
                this.speedY = Math.random() * 1 + 0.5;
                this.speedX = Math.random() * 2 - 1;
                this.vx = 0; this.vy = 0;
                this.color = `rgba(255, ${Math.floor(Math.random() * 50 + 200)}, ${Math.floor(Math.random() * 50 + 200)}, ${Math.random() * 0.5 + 0.3})`;
                this.angle = Math.random() * 360;
                this.spin = Math.random() * 2 - 1;
            }
            update() {
                this.vx += (windX - this.vx) * 0.1; 
                this.vy += (windY - this.vy) * 0.1;
                this.y += this.speedY + this.vy;
                this.x += Math.sin(this.angle * 0.01) + this.speedX + this.vx; 
                this.angle += this.spin;
                if (this.y > canvas.height) { this.y = -20; this.x = Math.random() * canvas.width; this.vy = 0; }
                if (this.y < -50) this.y = canvas.height;
                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle * Math.PI / 180);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size, this.size / 2, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
        for (let i = 0; i < 80; i++) petals.push(new Petal());
        function animateSakura() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            petals.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateSakura);
        }
        animateSakura();

        // ==========================================
        // COM√àTES (Your Name)
        // ==========================================
        const cometContainer = document.getElementById('comet-container');
        function spawnComet() {
            const isFinalPhase = window.getComputedStyle(finalContent).opacity > 0.1;
            if (isFinalPhase) {
                createCometElement();
                if(Math.random() > 0.7) setTimeout(() => createCometElement(true), 200);
            }
            let nextSpawn = Math.random() * 6000 + 4000;
            setTimeout(spawnComet, nextSpawn);
        }

        function createCometElement(isPair = false) {
            const comet = document.createElement('div');
            const type = (Math.random() > 0.5 || isPair) ? 'pink' : 'blue';
            comet.classList.add('comet', type);
            comet.innerHTML = `<div class="comet-head"></div><div class="comet-tail"></div>`;
            const startY = Math.random() * (window.innerHeight / 2);
            const startX = window.innerWidth + 50;
            comet.style.top = startY + 'px';
            comet.style.left = startX + 'px';
            const duration = Math.random() * 2 + 3;
            comet.style.animation = `shooting-star ${duration}s linear forwards`;
            cometContainer.appendChild(comet);
            setTimeout(() => { comet.remove(); }, duration * 1000);
        }
        setTimeout(spawnComet, 2000);

        // ==========================================
        // MUSIQUE & VINYLE
        // ==========================================
        const audio = document.getElementById('bg-music');
        const vinylBtn = document.getElementById('vinyl-btn');
        const vinylContainer = document.getElementById('music-player-container');
        const heartIcon = document.querySelector('.vinyl-heart');
        let isPlaying = false;
        let audioContext, analyser, source;

        setInterval(() => {
            if(window.getComputedStyle(finalContent).opacity > 0.5) {
                vinylContainer.style.opacity = 1;
            }
        }, 1000);

        vinylBtn.addEventListener('click', () => {
            if(!isPlaying) {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    source = audioContext.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                    analyser.fftSize = 256;
                    visualizeHeartbeat();
                } else if (audioContext.state === 'suspended') { audioContext.resume(); }
                audio.play();
                vinylContainer.classList.add('playing');
                isPlaying = true;
            } else {
                audio.pause();
                vinylContainer.classList.remove('playing');
                isPlaying = false;
            }
        });

        function visualizeHeartbeat() {
            if(!isPlaying) return;
            requestAnimationFrame(visualizeHeartbeat);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            let bassSum = 0;
            for (let i = 0; i < 10; i++) bassSum += dataArray[i];
            let scale = 1 + (bassSum / 10 / 255) * 0.6;
            heartIcon.style.transform = `scale(${scale})`;
        }

        // ==========================================
        // COFFRE FORT & CARTE (BOUTONS)
        // ==========================================
        setTimeout(() => {
            if(finalContent) {
                // Bouton Carte
                const mapBtn = document.createElement('div');
                mapBtn.className = 'glass-panel interactive-panel';
                mapBtn.style.marginTop = '15px';
                mapBtn.innerHTML = `<div class="timer-label">üåç Notre Monde</div><div class="timer-val" style="font-size: 1rem; font-weight: normal;">Voir la Carte</div>`;
                mapBtn.onclick = openMap;
                finalContent.appendChild(mapBtn);

                // Bouton Coffre
                const vaultBtn = document.createElement('div');
                vaultBtn.className = 'glass-panel interactive-panel vault-btn';
                vaultBtn.style.marginTop = '10px';
                vaultBtn.innerHTML = `<div class="timer-label">‚ú® Chose Promise...</div><div class="timer-val" style="font-size: 1rem;">Ouvrir le Secret</div>`;
                vaultBtn.onclick = openSafe;
                finalContent.appendChild(vaultBtn);
            }
        }, 1000);

        // --- LOGIQUE COFFRE ---
        let currentCode = "";
        const SECRET_CODE = "1707";
        const safeModal = document.getElementById('safe-modal');
        const screen = document.getElementById('safe-screen');
        const interfaceDiv = document.getElementById('safe-interface');
        const rewardDiv = document.getElementById('reward-ticket');

        function openSafe() { safeModal.classList.add('open'); clearSafe(); }
        function closeSafe() { 
            safeModal.classList.remove('open');
            setTimeout(() => { interfaceDiv.style.display = 'block'; rewardDiv.style.display = 'none'; clearSafe(); }, 500);
        }
        function inputSafe(num) {
            if(currentCode.length < 4) {
                currentCode += num;
                updateScreen();
                if(currentCode.length === 4) checkCode();
            }
        }
        function clearSafe() { currentCode = ""; updateScreen(); screen.style.color = "#d6336c"; }
        function updateScreen() { screen.innerText = currentCode.padEnd(4, '‚Ä¢'); }
        function checkCode() {
            if(currentCode === SECRET_CODE) {
                screen.style.color = "#d4af37";
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                setTimeout(() => { interfaceDiv.style.display = 'none'; rewardDiv.style.display = 'block'; }, 600);
            } else {
                screen.style.color = "#ff0000";
                if(navigator.vibrate) navigator.vibrate(400);
                setTimeout(clearSafe, 800);
            }
        }

        // --- LOGIQUE CARTE ---
        const locations = [
            { name: "Montpellier", lat: 43.6117, lng: 3.8777, desc: "L√† o√π tout a commenc√© ‚ú®" },
            { name: "Toulouse", lat: 43.6047, lng: 1.4442, desc: "La ville de notre second Date üåπ" },
            { name: "Albi", lat: 43.9251, lng: 2.1486, desc: "Pour des f√™tes inoubliables üéâ" },
            { name: "Al√®s", lat: 44.1272, lng: 4.0850, desc: "L√† o√π je me repose avec toi üè°" },
            { name: "Lyon", lat: 45.7640, lng: 4.8357, desc: "Pour des soir√©es endiabl√©es üíÉ" },
            { name: "Le Mas de la Barque", lat: 44.4093, lng: 3.9118, desc: "Pour ton bonhomme de neige HelloKitty ‚õÑ" },
            { name: "Madrid", lat: 40.4168, lng: -3.7038, desc: "Notre future destination ! üá™üá∏" }
        ];

        let mapInitialized = false;
        let map;

        // Remplace ta fonction openMap() par celle-ci :
        function openMap() {
            document.getElementById('map-modal').classList.add('open');
            
            if (!mapInitialized) {
                // Cr√©ation de la carte
                map = L.map('map-container').setView([43.6, 2.5], 6); // Centr√© sur le sud
    
                // Fond de carte vintage
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19,
                    className: 'vintage-map-layer'
                }).addTo(map);
    
                // D√©finition de l'ic√¥ne (L'Emoji)
                const heartIcon = L.divIcon({
                    className: 'custom-pin', // Utilise notre CSS corrig√©
                    html: 'üìç', 
                    iconSize: [40, 40], // Taille forc√©e du conteneur
                    iconAnchor: [20, 40] // La pointe de l'√©pingle (milieu, bas)
                });
    
                // Ajout des marqueurs
                const markers = [];
                locations.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lng], {icon: heartIcon}).addTo(map);
                    
                    // Contenu de la bulle
                    const popupContent = `
                        <div style="font-family:'Zen Maru Gothic'; padding:5px;">
                            <h3 style="margin:0 0 5px 0; color:#d4af37;">${loc.name}</h3>
                            <p style="margin:0; font-size:0.9rem;">${loc.desc}</p>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markers.push(marker);
                });
    
                // Ajustement automatique du zoom pour tout voir
                const group = new L.featureGroup(markers);
                
                // Petit d√©lai pour laisser le temps √† la modale de s'ouvrir avant de calculer la taille
                setTimeout(() => {
                    map.invalidateSize(); // Force le redessin
                    map.fitBounds(group.getBounds().pad(0.2)); // Zoom sur les points
                }, 300);
    
                mapInitialized = true;
            }
        }

        function closeMap() {
            document.getElementById('map-modal').classList.remove('open');
        }

    </script>
</body>
</html>
