<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pour Toi</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- RESET & BASE --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* FOND DE D√âPART : D√©grad√© Sakura */
            background: linear-gradient(to bottom, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            font-family: 'Zen Maru Gothic', sans-serif;
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- ARRI√àRE-PLAN (SLIDESHOW) --- */
        #bg-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            opacity: 0; 
            transition: opacity 2s ease-in-out;
        }
        .bg-slide {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 2s ease-in-out;
        }
        .bg-slide.active { opacity: 1; }

        /* Filtre sombre */
        #overlay-filter {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(40, 10, 20, 0.5); 
            z-index: 1;
            opacity: 0;
            transition: opacity 2s;
        }

        /* --- CANVAS SAKURA (P√©tales) --- */
        #canvas-sakura {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2;
            pointer-events: none; /* Laisse passer les clics sauf quand on secoue */
        }

        /* --- CANVAS BU√âE (NOUVEAU) --- */
        #canvas-fog {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; /* Tout au dessus */
            cursor: crosshair;
            transition: opacity 1.5s ease-out;
        }

        /* --- CONTENEUR HISTOIRE --- */
        #story-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            text-align: center;
            color: white;
            width: 90%;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
            opacity: 0; /* Cach√© au d√©but par la bu√©e */
        }

        .big-icon { 
            font-size: 5rem; 
            margin-bottom: 20px; 
            display: block; 
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
            animation: float 3s infinite ease-in-out; 
        }
        
        .story-text { 
            font-family: 'Great Vibes', cursive; 
            font-size: 2.2rem; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            color: #d6336c; 
            transition: color 2s;
        }

        @keyframes float { 0%, 100% {transform: translateY(0) scale(1);} 50% {transform: translateY(-15px) scale(1.1);} }

        /* --- CONTENU FINAL --- */
        #final-content {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            opacity: 0; 
            transition: opacity 2.5s ease-out; 
            pointer-events: none; 
            display: none; 
        }

        h1 {
            font-family: 'Great Vibes', cursive;
            font-size: 3.5rem;
            color: #fff0f5;
            margin: 0 0 10px 0;
            text-shadow: 0 4px 6px rgba(0,0,0,0.5);
            line-height: 1.2;
        }
        
        p.subtitle {
            font-size: 1.1rem;
            color: #ffd1dc;
            margin-bottom: 40px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            padding: 0 20px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 15px 25px;
            margin: 10px;
            width: 70%;
            max-width: 300px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .interactive-panel {
            cursor: pointer;
            transition: transform 0.2s;
            pointer-events: auto !important; 
        }
        .interactive-panel:active { transform: scale(0.95); }

        .timer-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: #ffb7c5; }
        .timer-val { font-size: 1.3rem; font-weight: bold; color: white; margin-top: 5px; }

    </style>
</head>
<body>

    <div id="bg-container"></div>
    <div id="overlay-filter"></div>

    <canvas id="canvas-sakura"></canvas>
    
    <canvas id="canvas-fog"></canvas>

    <div id="story-container">
        <span id="story-icon" class="big-icon">üëÜ</span>
        <span id="story-text" class="story-text">Touche l'√©cran...</span>
    </div>

    <div id="final-content">
        <h1>Joyeuse<br>Saint-Valentin</h1>
        <p class="subtitle">Pour mon √¢me soeur que j'aime tant</p>

        <div class="glass-panel">
            <div class="timer-label">Premier Bisou</div>
            <div id="timer-kiss" class="timer-val">...</div>
        </div>

        <div class="glass-panel">
            <div class="timer-label">Officiellement Nous</div>
            <div id="timer-official" class="timer-val">...</div>
        </div>

        <div class="glass-panel interactive-panel" style="margin-top: 25px; pointer-events: auto;" onclick="newReason()">
            <div class="timer-label">Pourquoi je t'aime ?</div>
            <div id="love-reason" class="timer-val" style="font-size: 1.1rem; font-weight: normal; min-height: 1.5em;">Clique ici...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const images = [
            'nous1.jpg', '1000014222.jpg', '1000014295.jpg',
            '1000014591.jpg', '1000014933.jpg', '1000015425.jpg',
            '1000016105.jpg', '1000022693.jpg'
        ];
        const dateKiss = new Date(2025, 5, 1, 0, 0, 0); 
        const dateOfficial = new Date(2025, 6, 17, 0, 0, 0); 

        // ==========================================
        // SC√âNARIO & RAISONS
        // ==========================================
        const scenario = [
            { text: "Pour ma meilleure amie et partenaire", icon: "üíê" }, 
            { text: "Pour celle qui me soutient et rend ma vie meilleure", icon: "üåü" }, 
            { text: "Pour celle que je n'abandonnerai jamais", icon: "‚ôæÔ∏è" }, 
            { text: "Laisse moi te montrer √† quel point je t'aime", icon: "üíå" } 
        ];

        const loveReasons = [
            "Parce que tu es ma personne pr√©f√©r√©e", "Pour la fa√ßon dont tu me regardes",
            "Parce qu'avec toi, tout est encore plus magique", "Pour ton rire qui illumine mes journ√©es",
            "Parce que tu me pousses vers le haut", "Pour nos projets futurs",
            "Parce que tu es belle √† l'int√©rieur comme √† l'ext√©rieur", "Pour ta gentillesse infinie",
            "Parce que je me sens prot√©g√© avec toi", "Parce que je serai pour toujours ton roi des cafards",
            "Parce que tu vaux infiniment plus que tout ce que l'on a d√©j√† dit sur toi",
            "Parce que tu prends soin de nous", "Parce que mon amour pour toi est infini"
        ];

        function newReason() {
            if(navigator.vibrate) navigator.vibrate(30);
            const reasonDiv = document.getElementById('love-reason');
            reasonDiv.style.opacity = 0;
            setTimeout(() => {
                const random = loveReasons[Math.floor(Math.random() * loveReasons.length)];
                reasonDiv.innerText = random;
                reasonDiv.style.opacity = 1;
            }, 300);
        }

        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let step = -1; 
        let isAnimating = false;
        let fogCleared = false; // Pour savoir si on a pass√© l'√©tape bu√©e

        // ==========================================
        // 1. LA BU√âE (FOG)
        // ==========================================
        const canvasFog = document.getElementById('canvas-fog');
        const ctxFog = canvasFog.getContext('2d');
        let width, height;

        function resizeFog() {
            canvasFog.width = window.innerWidth;
            canvasFog.height = window.innerHeight;
            // On remplit le canvas de "blanc givr√©"
            ctxFog.fillStyle = "rgba(255, 255, 255, 0.85)";
            ctxFog.fillRect(0, 0, canvasFog.width, canvasFog.height);
            
            // Petit texte d'indice sur la bu√©e
            ctxFog.globalCompositeOperation = 'source-over';
            ctxFog.font = "30px 'Great Vibes'";
            ctxFog.fillStyle = "#ff758c";
            ctxFog.textAlign = "center";
            ctxFog.fillText("Essuie la bu√©e...", canvasFog.width/2, canvasFog.height/2);
        }
        resizeFog();

        // Fonction pour "gratter"
        function scratch(x, y) {
            if(fogCleared) return;
            ctxFog.globalCompositeOperation = 'destination-out';
            ctxFog.beginPath();
            ctxFog.arc(x, y, 40, 0, Math.PI * 2); // Taille du doigt
            ctxFog.fill();
            checkFogCleared();
        }

        // V√©rifie si on a assez gratt√©
        let scratchCount = 0;
        function checkFogCleared() {
            scratchCount++;
            if(scratchCount > 60 && !fogCleared) { // Apr√®s environ 60 mouvements
                fogCleared = true;
                canvasFog.style.opacity = 0;
                document.getElementById('story-container').style.opacity = 1; // On r√©v√®le l'histoire
                setTimeout(() => { canvasFog.style.display = 'none'; }, 1500);
            }
        }

        // √âv√©nements pour gratter
        canvasFog.addEventListener('touchmove', function(e) {
            e.preventDefault(); // Emp√™che le scroll
            scratch(e.touches[0].clientX, e.touches[0].clientY);
        });
        canvasFog.addEventListener('mousemove', function(e) {
            if(e.buttons === 1) scratch(e.clientX, e.clientY);
        });


        // ==========================================
        // 2. BOULE √Ä NEIGE (ACC√âL√âROM√àTRE)
        // ==========================================
        let windX = 0;
        let windY = 0;
        
        // On √©coute les mouvements du t√©l√©phone
        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', function(event) {
                // On ne capture le mouvement que si on est √† l'√©tape finale
                if (step >= scenario.length) {
                    // Acc√©l√©ration (avec gravit√©)
                    let acc = event.accelerationIncludingGravity;
                    if (acc) {
                        // On lisse un peu les valeurs et on inverse X pour l'effet naturel
                        windX = -acc.x * 0.5; 
                        windY = acc.y * 0.5; 
                    }
                }
            });
        }


        // ==========================================
        // SLIDESHOW & TIMERS
        // ==========================================
        const bgContainer = document.getElementById('bg-container');
        if(images.length > 0) {
            images.forEach((img, i) => {
                const el = document.createElement('div');
                el.classList.add('bg-slide');
                el.style.backgroundImage = `url('${img}')`;
                if(i === 0) el.classList.add('active');
                bgContainer.appendChild(el);
            });
        }
        let curSlide = 0;
        function rotateSlide() {
            const slides = document.querySelectorAll('.bg-slide');
            if(slides.length > 1) {
                slides[curSlide].classList.remove('active');
                curSlide = (curSlide + 1) % slides.length;
                slides[curSlide].classList.add('active');
            }
        }
        setInterval(rotateSlide, 5000);

        function getDuration(startDate) {
            const now = new Date();
            const diff = now - startDate;
            if (diff < 0) return "Bient√¥t..."; 
            const days = Math.floor(diff / (86400000));
            const hours = Math.floor((diff % 86400000) / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            return `${days}j ${hours}h ${mins}m`;
        }
        function refreshTimers() {
            document.getElementById('timer-kiss').innerText = getDuration(dateKiss);
            document.getElementById('timer-official').innerText = getDuration(dateOfficial);
        }
        setInterval(refreshTimers, 1000);
        refreshTimers();


        // ==========================================
        // CANVAS SAKURA (Modifi√© pour Boule √† Neige)
        // ==========================================
        const canvas = document.getElementById('canvas-sakura');
        const ctx = canvas.getContext('2d');
        let petals = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Petal {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height; 
                this.size = Math.random() * 10 + 5;
                this.speedY = Math.random() * 1 + 0.5;
                this.speedX = Math.random() * 2 - 1;
                // Vitesse suppl√©mentaire due au vent (secousse)
                this.vx = 0;
                this.vy = 0;
                this.color = `rgba(255, ${Math.floor(Math.random() * 50 + 200)}, ${Math.floor(Math.random() * 50 + 200)}, ${Math.random() * 0.5 + 0.3})`;
                this.angle = Math.random() * 360;
                this.spin = Math.random() * 2 - 1;
            }
            update() {
                // Application de la physique "Boule √† Neige"
                // On ajoute l'acc√©l√©ration du t√©l√©phone √† la vitesse
                this.vx += (windX - this.vx) * 0.1; 
                this.vy += (windY - this.vy) * 0.1;

                this.y += this.speedY + this.vy;
                this.x += Math.sin(this.angle * 0.01) + this.speedX + this.vx; 
                this.angle += this.spin;

                // Reset si sort de l'√©cran
                if (this.y > canvas.height) {
                    this.y = -20;
                    this.x = Math.random() * canvas.width;
                    this.vy = 0; // Reset velocity
                }
                if (this.y < -50) this.y = canvas.height; // Si on secoue vers le haut

                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle * Math.PI / 180);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size, this.size / 2, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function initPetals() {
            petals = [];
            for (let i = 0; i < 80; i++) petals.push(new Petal());
        }
        initPetals();

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            petals.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        // ==========================================
        // GESTION DE L'INTERACTION
        // ==========================================
        
        const storyContainer = document.getElementById('story-container');
        const storyText = document.getElementById('story-text');
        const storyIcon = document.getElementById('story-icon');
        const finalContent = document.getElementById('final-content');
        const overlayFilter = document.getElementById('overlay-filter');

        function handleTap(e) {
            // On ne peut pas cliquer tant que la bu√©e n'est pas partie !
            if(!fogCleared) return; 

            if (e.target.closest('.interactive-panel')) return;

            if(isAnimating) return; 
            isAnimating = true;

            step++; 

            if (navigator.vibrate) navigator.vibrate(50);

            // --- CAS 1 : ON D√âROULE L'HISTOIRE ---
            if (step < scenario.length) {
                storyContainer.style.opacity = 0;

                setTimeout(() => {
                    storyText.innerText = scenario[step].text;
                    storyIcon.innerText = scenario[step].icon;
                    petals.forEach(p => { p.speedY += 1.5; });
                    storyContainer.style.opacity = 1;
                    isAnimating = false;
                }, 500);
            } 
            
            // --- CAS 2 : LE GRAND FINAL ---
            else {
                storyContainer.style.opacity = 0;
                
                setTimeout(() => {
                    storyContainer.style.display = 'none';
                    bgContainer.style.opacity = 1;
                    overlayFilter.style.opacity = 1;

                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

                    finalContent.style.display = 'flex';
                    setTimeout(() => {
                        finalContent.style.opacity = 1;
                        finalContent.style.pointerEvents = 'auto'; 
                        for(let i=0; i<50; i++) petals.push(new Petal());
                    }, 100);
                }, 500);
            }
        }

        window.addEventListener('touchstart', handleTap);
        window.addEventListener('click', handleTap);
        

    </script>
    <style>
    /* --- STYLES DU LECTEUR VINYLE --- */
    #music-player-container {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        opacity: 0; /* Cach√© au d√©but */
        transition: opacity 2s;
    }

    .vinyl-wrapper {
        width: 80px;
        height: 80px;
        position: relative;
        cursor: pointer;
    }

    .vinyl-disc {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: radial-gradient(circle, #111 20%, #333 21%, #111 22%, #111 30%, #333 31%, #111 32%, #111 40%, #222 100%);
        border: 2px solid rgba(255,255,255,0.2);
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        animation: spin 4s linear infinite;
        animation-play-state: paused; /* Pause par d√©faut */
    }

    .vinyl-label {
        width: 35%;
        height: 35%;
        background: #ff758c;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
    }

    /* Le c≈ìur qui va battre */
    .vinyl-heart {
        font-size: 1.2rem;
        color: white;
        transition: transform 0.1s ease-out; /* R√©actif pour la musique */
    }

    /* Bras de lecture (d√©coratif) */
    .tonearm {
        position: absolute;
        top: -10px;
        right: -5px;
        width: 30px;
        height: 40px;
        border-top: 3px solid #ccc;
        border-right: 3px solid #ccc;
        border-radius: 0 10px 0 0;
        transform-origin: top right;
        transform: rotate(0deg);
        transition: transform 0.5s;
        pointer-events: none;
    }
    .playing .tonearm { transform: rotate(25deg); }
    .playing .vinyl-disc { animation-play-state: running; }

    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* --- STYLES DU COFFRE FORT (MODAL) --- */
    #safe-modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        opacity: 0; pointer-events: none;
        transition: opacity 0.4s;
    }
    #safe-modal.open { opacity: 1; pointer-events: auto; }

    .safe-display {
        font-family: 'Courier New', monospace;
        background: #222;
        color: #0f0;
        padding: 15px;
        border-radius: 10px;
        border: 2px solid #444;
        font-size: 2rem;
        letter-spacing: 10px;
        margin-bottom: 20px;
        width: 200px;
        text-align: center;
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
    }

    .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .key-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        font-size: 1.5rem;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer;
        transition: background 0.2s;
    }
    .key-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

    /* Bouton d'acc√®s au coffre (ajout√© √† la liste principale) */
    .vault-btn {
        margin-top: 15px;
        background: rgba(255, 215, 0, 0.15) !important; /* Dor√© subtil */
        border: 1px solid rgba(255, 215, 0, 0.5) !important;
    }

    /* --- TICKET R√âCOMPENSE --- */
    #reward-ticket {
        display: none;
        background: linear-gradient(135deg, #fffbf0 0%, #fff 100%);
        border: 2px solid #d4af37;
        padding: 30px;
        text-align: center;
        color: #333;
        border-radius: 15px;
        box-shadow: 0 0 30px #d4af37;
        position: relative;
        overflow: hidden;
        animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-width: 80%;
    }
    
    #reward-ticket h2 {
        font-family: 'Great Vibes', cursive;
        color: #d4af37;
        font-size: 2.5rem;
        margin: 0;
        text-shadow: none;
    }
    
    .stamp {
        border: 3px double #d4af37;
        padding: 10px;
        margin-top: 15px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-size: 0.9rem;
    }

    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
</style>

<audio id="bg-music" src="Gorillaz.mp3" loop crossOrigin="anonymous"></audio>

<div id="music-player-container">
    <div class="vinyl-wrapper" id="vinyl-btn">
        <div class="tonearm"></div>
        <div class="vinyl-disc">
            <div class="vinyl-label">
                <div class="vinyl-heart">‚ù§Ô∏è</div>
            </div>
        </div>
    </div>
</div>

<div id="safe-modal">
    <div id="safe-interface">
        <div style="color:white; margin-bottom:10px;">Entre le code secret</div>
        <div class="safe-display" id="safe-screen">----</div>
        <div class="keypad">
            <div class="key-btn" onclick="inputSafe(1)">1</div>
            <div class="key-btn" onclick="inputSafe(2)">2</div>
            <div class="key-btn" onclick="inputSafe(3)">3</div>
            <div class="key-btn" onclick="inputSafe(4)">4</div>
            <div class="key-btn" onclick="inputSafe(5)">5</div>
            <div class="key-btn" onclick="inputSafe(6)">6</div>
            <div class="key-btn" onclick="inputSafe(7)">7</div>
            <div class="key-btn" onclick="inputSafe(8)">8</div>
            <div class="key-btn" onclick="inputSafe(9)">9</div>
            <div class="key-btn" style="font-size:1rem" onclick="closeSafe()">‚ùå</div>
            <div class="key-btn" onclick="inputSafe(0)">0</div>
            <div class="key-btn" style="font-size:1rem" onclick="clearSafe()">‚¨ÖÔ∏è</div>
        </div>
    </div>

    <div id="reward-ticket">
        <h2>F√©licitations</h2>
        <p>Ce ticket est unique et valable pour :</p>
        <div class="stamp">UN RESTO DE TON CHOIX</div>
        <p style="font-size:0.8rem; margin-top:10px; color:#888;">Valid√© par le code 1707</p>
        <button onclick="closeSafe()" style="margin-top:20px; padding:10px 20px; background:#d4af37; color:white; border:none; border-radius:5px;">Merci mon amour !</button>
    </div>
</div>

<script>
    // --------------------------------------------------------
    // GESTION DU COFFRE FORT
    // --------------------------------------------------------
    
    // 1. On injecte le bouton "Zone Secr√®te" dans le contenu final existant
    // On attend que la page soit charg√©e pour √™tre s√ªr que 'final-content' existe
    setTimeout(() => {
        const finalContentDiv = document.getElementById('final-content');
        if(finalContentDiv) {
            const vaultBtn = document.createElement('div');
            vaultBtn.className = 'glass-panel interactive-panel vault-btn';
            vaultBtn.innerHTML = `
                <div class="timer-label">üîí Zone Secr√®te</div>
                <div class="timer-val" style="font-size: 1rem; font-weight: normal;">D√©verrouiller</div>
            `;
            vaultBtn.onclick = openSafe;
            finalContentDiv.appendChild(vaultBtn);
        }
        
        // On affiche aussi le lecteur de musique une fois √† la fin
        // On se base sur l'observer de changement d'opacit√© de final-content
        // Mais pour faire simple, on l'affiche quand final-content est visible
        setInterval(() => {
            if(window.getComputedStyle(document.getElementById('final-content')).opacity > 0.5) {
                document.getElementById('music-player-container').style.opacity = 1;
            }
        }, 1000);

    }, 1000);

    let currentCode = "";
    const SECRET_CODE = "1707";
    const modal = document.getElementById('safe-modal');
    const screen = document.getElementById('safe-screen');
    const interfaceDiv = document.getElementById('safe-interface');
    const rewardDiv = document.getElementById('reward-ticket');

    function openSafe() {
        modal.classList.add('open');
        clearSafe();
    }

    function closeSafe() {
        modal.classList.remove('open');
        // Reset si on r√©ouvre
        setTimeout(() => {
            interfaceDiv.style.display = 'block';
            rewardDiv.style.display = 'none';
            clearSafe();
        }, 500);
    }

    function inputSafe(num) {
        if(currentCode.length < 4) {
            currentCode += num;
            updateScreen();
            if(currentCode.length === 4) {
                checkCode();
            }
        }
    }

    function clearSafe() {
        currentCode = "";
        updateScreen();
        screen.style.borderColor = "#444";
        screen.style.color = "#0f0";
    }

    function updateScreen() {
        screen.innerText = currentCode.padEnd(4, '-');
    }

    function checkCode() {
        if(currentCode === SECRET_CODE) {
            screen.style.borderColor = "#d4af37"; // Or
            screen.style.color = "#d4af37";
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            
            setTimeout(() => {
                interfaceDiv.style.display = 'none';
                rewardDiv.style.display = 'block';
                // Confetti effet simple (optionnel)
            }, 500);
        } else {
            screen.style.borderColor = "red";
            screen.style.color = "red";
            if(navigator.vibrate) navigator.vibrate(400);
            setTimeout(clearSafe, 800);
        }
    }


    // --------------------------------------------------------
    // GESTION MUSIQUE & VISUALIZER (C≈íUR QUI BAT)
    // --------------------------------------------------------
    const audio = document.getElementById('bg-music');
    const vinylBtn = document.getElementById('vinyl-btn');
    const vinylContainer = document.getElementById('music-player-container');
    const heartIcon = document.querySelector('.vinyl-heart');
    
    let isPlaying = false;
    let audioContext, analyser, source;

    vinylBtn.addEventListener('click', () => {
        if(!isPlaying) {
            // Initialisation AudioContext (n√©cessite clic utilisateur)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                analyser.fftSize = 256; // Pr√©cision
                visualizeHeartbeat();
            } else if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            audio.play();
            vinylContainer.classList.add('playing');
            isPlaying = true;
        } else {
            audio.pause();
            vinylContainer.classList.remove('playing');
            isPlaying = false;
            heartIcon.style.transform = 'scale(1)'; // Reset
        }
    });

    // Fonction qui fait battre le c≈ìur sur les basses
    function visualizeHeartbeat() {
        if(!isPlaying) return;
        
        requestAnimationFrame(visualizeHeartbeat);
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        // On se concentre sur les basses fr√©quences (les premiers index du tableau)
        // Disons les 10 premi√®res bandes de fr√©quence
        let bassSum = 0;
        let bassCount = 10;
        for (let i = 0; i < bassCount; i++) {
            bassSum += dataArray[i];
        }
        let bassAverage = bassSum / bassCount;

        // Calcul du scale : 1 (base) + intensit√©
        // bassAverage est entre 0 et 255. On veut un scale entre 1.0 et 1.4 max
        let scale = 1 + (bassAverage / 255) * 0.5;

        // Application au petit c≈ìur au centre du vinyle
        heartIcon.style.transform = `scale(${scale})`;
    }

</script>
</body>
</html>
